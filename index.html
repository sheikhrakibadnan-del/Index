// Constants
const POINTS_PER_AD = 0.50;
const WITHDRAW_FEE_PERCENT = 5;
const MIN_WITHDRAW = 10;

// State variables
let watchedAdsCount = 0;
let earnedPoints = 0;
let autoAdInterval;
let currentUser = null;
let userData = {};

// DOM Elements
const watchedAdsEl = document.getElementById('watched-ads');
const earnedPointsEl = document.getElementById('earned-points');
const currentBalanceEl = document.getElementById('current-balance');
const userNameEl = document.getElementById('user-name');
const userPhoneEl = document.getElementById('user-phone');
const logoutBtnEl = document.getElementById('logout-btn');
const withdrawBtnEl = document.getElementById('withdraw-btn');
const registeredPhoneEl = document.getElementById('registered-phone');
const withdrawAmountEl = document.getElementById('withdraw-amount');
const confirmWithdrawEl = document.getElementById('confirm-withdraw');
const adNotificationEl = document.getElementById('ad-notification');

// Initialize the app
function initApp() {
    // Firebase Auth State Listener
    auth.onAuthStateChanged(async user => {
        if (user) {
            currentUser = user;
            await loadUserData(user.uid);
            setupEventListeners();
        } else {
            window.location.href = "index.html";
        }
    });
}

// Load user data from Firestore
async function loadUserData(userId) {
    try {
        const doc = await db.collection('users').doc(userId).get();
        
        if (doc.exists) {
            userData = doc.data();
            watchedAdsCount = userData.watchedAds || 0;
            earnedPoints = userData.balance || 0;
            
            // Update UI
            userNameEl.textContent = userData.name || "User";
            userPhoneEl.textContent = userData.phone || "N/A";
            registeredPhoneEl.textContent = userData.phone || "N/A";
            updateUI();
        }
    } catch (error) {
        console.error("Error loading user data:", error);
        showNotification("Failed to load user data");
    }
}

// Update UI elements
function updateUI() {
    watchedAdsEl.textContent = watchedAdsCount;
    earnedPointsEl.textContent = earnedPoints.toFixed(2);
    currentBalanceEl.textContent = earnedPoints.toFixed(2);
}

// Watch ad function
async function watchAd() {
    if (!currentUser) return;
    
    showNotification("Loading ad... Please wait");
    
    try {
        // Show Monetag ad
        if (typeof show_9593694 === 'function') {
            await show_9593694();
        } else {
            // Fallback to simulated ad
            await new Promise(resolve => setTimeout(resolve, 2000));
        }
        
        // Update points
        earnedPoints += POINTS_PER_AD;
        
        // Save to Firestore
        await db.collection('users').doc(currentUser.uid).update({
            balance: firebase.firestore.FieldValue.increment(POINTS_PER_AD),
            watchedAds: firebase.firestore.FieldValue.increment(1)
        });
        
        // Update local data
        watchedAdsCount++;
        userData.balance = earnedPoints;
        
        updateUI();
        showNotification("Ad completed! +0.50 points added");
    } catch (error) {
        console.error("Ad error:", error);
        showNotification("Failed to show ad. Please try again.");
    }
}

// Withdraw function
async function processWithdrawal() {
    const amount = parseFloat(withdrawAmountEl.value);
    
    if (!amount || amount < MIN_WITHDRAW) {
        showNotification(`Minimum withdrawal is ${MIN_WITHDRAW} points`);
        return;
    }
    
    if (amount > earnedPoints) {
        showNotification("Insufficient balance");
        return;
    }
    
    // Calculate fee
    const fee = Math.max(1, (amount * WITHDRAW_FEE_PERCENT / 100));
    const netAmount = amount - fee;
    
    try {
        // Create withdrawal record
        await db.collection('withdrawals').add({
            userId: currentUser.uid,
            userName: userData.name,
            userPhone: userData.phone,
            amount: amount,
            fee: fee,
            netAmount: netAmount,
            method: "bkash",
            status: "pending",
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Update user balance
        await db.collection('users').doc(currentUser.uid).update({
            balance: firebase.firestore.FieldValue.increment(-amount),
            totalWithdrawn: firebase.firestore.FieldValue.increment(amount)
        });
        
        // Update local data
        earnedPoints -= amount;
        userData.balance = earnedPoints;
        updateUI();
        
        // Close modal and show success
        document.getElementById('withdraw-modal').style.display = "none";
        showNotification(`Withdrawal request submitted! Net amount: ${netAmount.toFixed(2)} points`);
    } catch (error) {
        console.error("Withdrawal error:", error);
        showNotification("Withdrawal failed: " + error.message);
    }
}

// Show notification
function showNotification(message) {
    if (!adNotificationEl) return;
    
    adNotificationEl.textContent = message;
    adNotificationEl.style.display = 'block';
    
    setTimeout(() => {
        adNotificationEl.style.display = 'none';
    }, 3000);
}

// Setup event listeners
function setupEventListeners() {
    // Watch ad button
    if (document.getElementById('watch-ad-btn')) {
        document.getElementById('watch-ad-btn').addEventListener('click', watchAd);
    }
    
    // Auto ads buttons
    if (document.getElementById('auto-ad-btn')) {
        document.getElementById('auto-ad-btn').addEventListener('click', () => {
            autoAdInterval = setInterval(watchAd, 30000);
            showNotification("Auto ads started. Ads will play every 30 seconds.");
        });
    }
    
    if (document.getElementById('stop-auto-btn')) {
        document.getElementById('stop-auto-btn').addEventListener('click', () => {
            clearInterval(autoAdInterval);
            showNotification("Auto ads stopped.");
        });
    }
    
    // Withdraw button
    if (withdrawBtnEl) {
        withdrawBtnEl.addEventListener('click', () => {
            document.getElementById('withdraw-modal').style.display = "flex";
        });
    }
    
    // Confirm withdraw
    if (confirmWithdrawEl) {
        confirmWithdrawEl.addEventListener('click', processWithdrawal);
    }
    
    // Close modal
    if (document.querySelector('.close-modal')) {
        document.querySelector('.close-modal').addEventListener('click', () => {
            document.getElementById('withdraw-modal').style.display = "none";
        });
    }
    
    // Logout button
    if (logoutBtnEl) {
        logoutBtnEl.addEventListener('click', () => {
            auth.signOut();
        });
    }
}

// Initialize app when DOM is loaded
document.addEventListener('DOMContentLoaded', initApp);
